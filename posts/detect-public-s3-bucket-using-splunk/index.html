<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Detect Public S3 Bucket using Splunk | logsec</title>
<meta name=keywords content>
<meta name=description content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -">
<meta name=author content>
<link rel=canonical href=https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Detect Public S3 Bucket using Splunk">
<meta property="og:description" content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"><meta property="og:image" content="https://www.logsec.cloud/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-06-20T00:00:00+00:00">
<meta property="article:modified_time" content="2020-06-20T00:00:00+00:00"><meta property="og:site_name" content="ExampleSite">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://www.logsec.cloud/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="Detect Public S3 Bucket using Splunk">
<meta name=twitter:description content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.logsec.cloud/posts/"},{"@type":"ListItem","position":3,"name":"Detect Public S3 Bucket using Splunk","item":"https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Detect Public S3 Bucket using Splunk","name":"Detect Public S3 Bucket using Splunk","description":"In today\u0026rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.\nScenario 1: Using the AWS Web Console Create a S3 bucket and Go to \u0026ldquo;Permissions\u0026rdquo; - \u0026ldquo;Access Control List\u0026rdquo; - \u0026ldquo;Public Access\u0026rdquo; - \u0026ldquo;Everyone\u0026rdquo; - Access to the objects -","keywords":[],"articleBody":"In today’s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.\nScenario 1: Using the AWS Web Console Create a S3 bucket and Go to “Permissions” - “Access Control List” - “Public Access” - “Everyone” - Access to the objects -\n List Objects [*]: Allows Gurantee to list the objects in the bucket Write Objects [*]: Allows Gurantee to create and delete the objects in the bucket  Go to “Permissions” - “Access Control List” - “Public Access” - “Everyone” - Access to this bucket’s ACL -\n Read bucket permissions: Allow Gurantee to read the bucket ACL Write bucket permissions: Allow Gurantee to edit the bucket ACL  To detect the first two scenarios, below Splunk search will work:\nindex=\"*\" sourcetype=\"aws:cloudtrail\"eventName=CreateBucket OR eventName=PutBucketAcl OR eventName=PutObjectAcl requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=\"http://acs.amazonaws.com/groups/global/AllUsers\" OR requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=\"http://acs.amazonaws.com/groups/global/AuthenticatedUsers\" | rename requestParameters.AccessControlPolicy.Owner.DisplayName as bucketOwner | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)\rScenario 2: Using the AWS CLI to create a bucket with a public-read policy: $ aws s3api create-bucket --acl public-read --bucket BUCKET_NAME --region us-east-1 Other Possible values are: [CANNED ACLs]\n private public-read public-read-write authenticated-read  Reference: Create-Bucket\nTesting the value: authenticated-read: Add the “Any AWS User” under the Public Access. Even though this option to add Authenticated User is now removed from the AWS Console, but you can still use it using the AWS CLI.\nSPL:\n\"requestParameters.x-amz-acl{}\"=\"public-*\"\rTo detect both values:\n public-read public-read-write  aws s3api create-bucket --acl authenticated-read --bucket BUCKET_NAME --region us-east-1 SPL:\n\"requestParameters.x-amz-acl{}\"=\"authenticated-read\"\rCombining the events under Scenario 2, SPL will look like this:\nindex=\"*\" sourcetype=\"aws:cloudtrail\" eventName=CreateBucket OR eventName=\"Put*Acl\" \"requestParameters.x-amz-acl{}\"=\"public-*\" OR \"requestParameters.x-amz-acl{}\"=\"authenticated-read\" | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)\rScenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line CLI Command used:\naws s3api create-bucket --bucket BUCKET_NAME --region us-east-1 --grant-write-acp uri=\"http://acs.amazonaws.com/groups/global/AllUsers\" [--grant-full-control ] [--grant-read ] [--grant-read-acp ] [--grant-write ]- [--grant-write-acp ] Here value could be either “http://acs.amazonaws.com/groups/global/AuthenticatedUsers\" OR “http://acs.amazonaws.com/groups/global/AllUsers\"\nReference:\nUsing API-Level (s3api) commands with the AWS CLI\nSPL:\neventName=CreateBucket requestParameters.x-amz-grant-read{}=\"uri=http://acs.amazonaws.com/groups/global/AllUsers\"\rCombining all the posible values, SPL will look like:\n(requestParameters.x-amz-grant-full-control{}=\"*AllUsers\" OR requestParameters.x-amz-grant-full-control{}=\"*AuthenticatedUsers\")\r(requestParameters.x-amz-grant-read{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read-acp{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write-acp{}=\"*AuthenticatedUsers\")\r Consolidatig all the above searches, to detect all possible scenarios, our complete search will be:\nindex=\"*\" sourcetype=\"aws:cloudtrail\" eventName=CreateBucket OR eventName=\"Put*Acl\" (\"requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI\"=\"http://acs.amazonaws.com/groups/global/AllUsers\") OR (requestParameters.x-amz-grant-full-control{}=\"*AllUsers\" OR requestParameters.x-amz-grant-full-control{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read-acp{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write-acp{}=\"*AuthenticatedUsers\") | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)\rIf you are importing the S3 Server Access Logs in to Splunk, you can use geostats command to generate statistics to display geographic data and summarize the data on maps.\nindex=\"*\" sourcetype=\"aws:s3:accesslogs\" | iplocation remote_ip\r| geostats count BY remote_ip\rKnown false positives: There could be undesired alerts that can occur from this search, when someone intentionally creates a public bucket. In this case, consider adding speicific buckets to whitelist.\nHow to respond: When this alert fires, ask yourself these questions. Is it still public? This is easy to detect, just search the logs for the bucket name and PutBucketACL, to see any subsequent ACL changes. Are the files public? and What is in it? These can be detected using S3 Access logs.\nHow to prevent: Configure S3 Block Public Access on the AWS account level (applies to all S3 buckets in all regions). S3 Block Public Access provides four settings:\n Block Public ACLs: Prevent any new operations to make buckets or objects public through Bucket or Object ACLs. (existing policies and ACLs for buckets and objects are not modified.) Ignore Public ACLs: Ignore all public ACLs on a bucket and any objects that it contains Block Public Policy: Reject calls to PUT Bucket policy if the specified bucket policy allows public access. (Enabling this setting doesn’t affect existing bucket policies) Restrict Public Buckets: Restrict access to a bucket with a public policy to only AWS services and authorized users within the bucket owner’s account.  provider \"aws\" { } resource \"aws_s3_account_public_access_block\" \"BlockPublicAccess\" { block_public_acls = \"true\" ignore_public_acls = \"true\" block_public_policy = \"true\" restrict_public_buckets = \"true\" } ","wordCount":"754","inLanguage":"en","datePublished":"2020-06-20T00:00:00Z","dateModified":"2020-06-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"},"publisher":{"@type":"Organization","name":"logsec","logo":{"@type":"ImageObject","url":"https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://www.logsec.cloud accesskey=h title="logsec (Alt + H)">logsec</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://www.logsec.cloud/pages/about title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://www.logsec.cloud/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=https://www.logsec.cloud/search/ title=search>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://www.logsec.cloud>Home</a>&nbsp;»&nbsp;<a href=https://www.logsec.cloud/posts/>Posts</a></div>
<h1 class=post-title>
Detect Public S3 Bucket using Splunk
</h1>
<div class=post-meta><span title="2020-06-20 00:00:00 +0000 UTC">June 20, 2020</span>&nbsp;·&nbsp;4 min
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#scenario-1-using-the-aws-web-console aria-label="Scenario 1: Using the AWS Web Console"><strong>Scenario 1: Using the AWS Web Console</strong></a></li>
<li>
<a href=#scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy aria-label="Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:"><strong>Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:</strong></a></li>
<li>
<a href=#scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line aria-label="Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line"><strong>Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line</strong></a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p>In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of <a href=https://www.logsec.cloud>logsec.cloud</a> in <a href=https://aws.amazon.com/route53/ title="AWS Route 53 Documentation">Route53</a>.</p>
<h3 id=scenario-1-using-the-aws-web-console><strong>Scenario 1: Using the AWS Web Console</strong><a hidden class=anchor aria-hidden=true href=#scenario-1-using-the-aws-web-console>#</a></h3>
<p>Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; -
Access to the objects -</p>
<ul>
<li>List Objects [*]: Allows Gurantee to list the objects in the bucket</li>
<li>Write Objects [*]: Allows Gurantee to create and delete the objects in the bucket</li>
</ul>
<p><img loading=lazy src=/images/2020_06_19_1.jpg alt>
</p>
<p>Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; -
Access to this bucket&rsquo;s ACL -</p>
<ul>
<li>Read bucket permissions: Allow Gurantee to read the bucket ACL</li>
<li>Write bucket permissions: Allow Gurantee to edit the bucket ACL</li>
</ul>
<p>To detect the first two scenarios, below Splunk search will work:</p>
<pre tabindex=0><code>index=&quot;*&quot; sourcetype=&quot;aws:cloudtrail&quot;eventName=CreateBucket OR eventName=PutBucketAcl OR eventName=PutObjectAcl 
    requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=&quot;http://acs.amazonaws.com/groups/global/AllUsers&quot; 
    OR requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=&quot;http://acs.amazonaws.com/groups/global/AuthenticatedUsers&quot; 
| rename requestParameters.AccessControlPolicy.Owner.DisplayName as bucketOwner  
| eval time=strftime(_time,&quot;%c %p&quot;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><h3 id=scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy><strong>Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:</strong><a hidden class=anchor aria-hidden=true href=#scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ aws s3api create-bucket --acl public-read --bucket BUCKET_NAME --region us-east-1
</code></pre></div><p>Other Possible values are: [CANNED ACLs]</p>
<ul>
<li>private</li>
<li>public-read</li>
<li>public-read-write</li>
<li>authenticated-read</li>
</ul>
<p>Reference: <a href=https://docs.aws.amazon.com/cli/latest/reference/s3api/create-bucket.html title="AWS CLI Command Reference">Create-Bucket</a></p>
<p>Testing the value: authenticated-read: Add the &ldquo;Any AWS User&rdquo; under the Public Access. Even though this option to add Authenticated User is now removed from the AWS Console, but you can still use it using the AWS CLI.</p>
<p><img loading=lazy src=/images/2020_06_19_2.jpg alt>
</p>
<p>SPL:</p>
<pre tabindex=0><code>&quot;requestParameters.x-amz-acl{}&quot;=&quot;public-*&quot;
</code></pre><p>To detect both values:</p>
<ul>
<li>public-read</li>
<li>public-read-write</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws s3api create-bucket --acl authenticated-read --bucket BUCKET_NAME --region us-east-1
</code></pre></div><p>SPL:</p>
<pre tabindex=0><code>&quot;requestParameters.x-amz-acl{}&quot;=&quot;authenticated-read&quot;
</code></pre><p>Combining the events under Scenario 2, SPL will look like this:</p>
<pre tabindex=0><code>index=&quot;*&quot; sourcetype=&quot;aws:cloudtrail&quot; eventName=CreateBucket OR eventName=&quot;Put*Acl&quot; &quot;requestParameters.x-amz-acl{}&quot;=&quot;public-*&quot; OR &quot;requestParameters.x-amz-acl{}&quot;=&quot;authenticated-read&quot; 
| eval time=strftime(_time,&quot;%c %p&quot;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><h3 id=scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line><strong>Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line</strong><a hidden class=anchor aria-hidden=true href=#scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line>#</a></h3>
<p>CLI Command used:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws s3api create-bucket --bucket BUCKET_NAME --region us-east-1 --grant-write-acp uri<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://acs.amazonaws.com/groups/global/AllUsers&#34;</span>
<span style=color:#f92672>[</span>--grant-full-control &lt;value&gt;<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>--grant-read &lt;value&gt;<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>--grant-read-acp &lt;value&gt;<span style=color:#f92672>]</span>
<span style=color:#f92672>[</span>--grant-write &lt;value&gt;<span style=color:#f92672>]</span>- 
<span style=color:#f92672>[</span>--grant-write-acp &lt;value&gt;<span style=color:#f92672>]</span>
</code></pre></div><p>Here <code>value</code> could be either &ldquo;<a href=http://acs.amazonaws.com/groups/global/AuthenticatedUsers%22>http://acs.amazonaws.com/groups/global/AuthenticatedUsers"</a> OR &ldquo;<a href=http://acs.amazonaws.com/groups/global/AllUsers%22>http://acs.amazonaws.com/groups/global/AllUsers"</a></p>
<p>Reference:<br>
<a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-apicommands.html title="s3 api Documentation">Using API-Level (s3api) commands with the AWS CLI</a></p>
<p>SPL:</p>
<pre tabindex=0><code>eventName=CreateBucket requestParameters.x-amz-grant-read{}=&quot;uri=http://acs.amazonaws.com/groups/global/AllUsers&quot;
</code></pre><p>Combining all the posible values, SPL will look like:</p>
<pre tabindex=0><code>(requestParameters.x-amz-grant-full-control{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-full-control{}=&quot;*AuthenticatedUsers&quot;)
(requestParameters.x-amz-grant-read{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-read{}=&quot;*AuthenticatedUsers&quot;) OR
(requestParameters.x-amz-grant-read-acp{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-read-acp{}=&quot;*AuthenticatedUsers&quot;) OR
(requestParameters.x-amz-grant-write{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-write{}=&quot;*AuthenticatedUsers&quot;) OR
(requestParameters.x-amz-grant-write-acp{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-write-acp{}=&quot;*AuthenticatedUsers&quot;)
</code></pre><hr>
<p>Consolidatig all the above searches, to detect all possible scenarios, our complete search will be:</p>
<pre tabindex=0><code>index=&quot;*&quot; sourcetype=&quot;aws:cloudtrail&quot; eventName=CreateBucket OR eventName=&quot;Put*Acl&quot;  
(&quot;requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI&quot;=&quot;http://acs.amazonaws.com/groups/global/AllUsers&quot;) OR  
(requestParameters.x-amz-grant-full-control{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-full-control{}=&quot;*AuthenticatedUsers&quot;) OR
    (requestParameters.x-amz-grant-read{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-read{}=&quot;*AuthenticatedUsers&quot;) OR
    (requestParameters.x-amz-grant-read-acp{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-read-acp{}=&quot;*AuthenticatedUsers&quot;) OR
    (requestParameters.x-amz-grant-write{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-write{}=&quot;*AuthenticatedUsers&quot;) OR
    (requestParameters.x-amz-grant-write-acp{}=&quot;*AllUsers&quot; OR requestParameters.x-amz-grant-write-acp{}=&quot;*AuthenticatedUsers&quot;) 
| eval time=strftime(_time,&quot;%c %p&quot;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><p>If you are importing the S3 Server Access Logs in to Splunk, you can use <code>geostats</code> command to generate statistics to display geographic data and summarize the data on maps.</p>
<pre tabindex=0><code>index=&quot;*&quot; sourcetype=&quot;aws:s3:accesslogs&quot; 
| iplocation remote_ip
| geostats count BY remote_ip
</code></pre><p><img loading=lazy src=/images/2020_06_19_3.jpg alt>
</p>
<p><strong>Known false positives:</strong> There could be undesired alerts that can occur from this search, when someone intentionally creates a public bucket. In this case, consider adding speicific buckets to whitelist.</p>
<p><strong>How to respond:</strong> When this alert fires, ask yourself these questions. Is it still public? This is easy to detect, just search the logs for the bucket name and PutBucketACL, to see any subsequent ACL changes. Are the files public? and What is in it? These can be detected using S3 Access logs.</p>
<p><strong>How to prevent:</strong> Configure S3 Block Public Access on the AWS account level (applies to all S3 buckets in all regions). S3 Block Public Access provides four settings:</p>
<ul>
<li><strong>Block Public ACLs</strong>: Prevent any new operations to make buckets or objects public through Bucket or Object ACLs. (existing policies and ACLs for buckets and objects are not modified.)</li>
<li><strong>Ignore Public ACLs</strong>: Ignore all public ACLs on a bucket and any objects that it contains</li>
<li><strong>Block Public Policy</strong>: Reject calls to PUT Bucket policy if the specified bucket policy allows public access. (Enabling this setting doesn&rsquo;t affect existing bucket policies)</li>
<li><strong>Restrict Public Buckets</strong>: Restrict access to a bucket with a public policy to only AWS services and authorized users within the bucket owner&rsquo;s account.</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_account_public_access_block&#34;</span> <span style=color:#e6db74>&#34;BlockPublicAccess&#34;</span> {
  <span style=color:#a6e22e>block_public_acls</span> = <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#a6e22e>ignore_public_acls</span> = <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#a6e22e>block_public_policy</span> = <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#a6e22e>restrict_public_buckets</span> = <span style=color:#e6db74>&#34;true&#34;</span>
}
</code></pre></div>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://www.logsec.cloud/posts/dnscat2-demo-on-aws/>
<span class=title>« Prev Page</span>
<br>
<span>dnscat2: Command and Control over the DNS</span>
</a>
<a class=next href=https://www.logsec.cloud/posts/investigating-on-aws/>
<span class=title>Next Page »</span>
<br>
<span>Investigating S3 Scanning Activites on AWS</span>
</a>
</nav>
</footer><script src=https://giscus.app/client.js data-repo=harwinds/logsec data-repo-id=R_kgDOGjnARg data-category=Announcements data-category-id=DIC_kwDOGjnARs4CAWru data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark data-lang=en crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://www.logsec.cloud>logsec</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>