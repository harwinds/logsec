<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Detect Public S3 Bucket using Splunk | logsec</title><meta name=keywords content><meta name=description content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -"><meta name=author content><link rel=canonical href=https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Detect Public S3 Bucket using Splunk"><meta property="og:description" content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -"><meta property="og:type" content="article"><meta property="og:url" content="https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"><meta property="og:image" content="https://www.logsec.cloud/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-20T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-20T00:00:00+00:00"><meta property="og:site_name" content="logsec"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.logsec.cloud/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Detect Public S3 Bucket using Splunk"><meta name=twitter:description content="In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.
Scenario 1: Using the AWS Web Console Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; - Access to the objects -"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://www.logsec.cloud/posts/"},{"@type":"ListItem","position":3,"name":"Detect Public S3 Bucket using Splunk","item":"https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Detect Public S3 Bucket using Splunk","name":"Detect Public S3 Bucket using Splunk","description":"In today\u0026rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.\nScenario 1: Using the AWS Web Console Create a S3 bucket and Go to \u0026ldquo;Permissions\u0026rdquo; - \u0026ldquo;Access Control List\u0026rdquo; - \u0026ldquo;Public Access\u0026rdquo; - \u0026ldquo;Everyone\u0026rdquo; - Access to the objects -","keywords":[],"articleBody":"In today’s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of logsec.cloud in Route53.\nScenario 1: Using the AWS Web Console Create a S3 bucket and Go to “Permissions” - “Access Control List” - “Public Access” - “Everyone” - Access to the objects -\nList Objects [*]: Allows Gurantee to list the objects in the bucket Write Objects [*]: Allows Gurantee to create and delete the objects in the bucket Go to “Permissions” - “Access Control List” - “Public Access” - “Everyone” - Access to this bucket’s ACL -\nRead bucket permissions: Allow Gurantee to read the bucket ACL Write bucket permissions: Allow Gurantee to edit the bucket ACL To detect the first two scenarios, below Splunk search will work:\nindex=\"*\" sourcetype=\"aws:cloudtrail\"eventName=CreateBucket OR eventName=PutBucketAcl OR eventName=PutObjectAcl requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=\"http://acs.amazonaws.com/groups/global/AllUsers\" OR requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=\"http://acs.amazonaws.com/groups/global/AuthenticatedUsers\" | rename requestParameters.AccessControlPolicy.Owner.DisplayName as bucketOwner | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index) Scenario 2: Using the AWS CLI to create a bucket with a public-read policy: $ aws s3api create-bucket --acl public-read --bucket BUCKET_NAME --region us-east-1 Other Possible values are: [CANNED ACLs]\nprivate public-read public-read-write authenticated-read Reference: Create-Bucket\nTesting the value: authenticated-read: Add the “Any AWS User” under the Public Access. Even though this option to add Authenticated User is now removed from the AWS Console, but you can still use it using the AWS CLI.\nSPL:\n\"requestParameters.x-amz-acl{}\"=\"public-*\" To detect both values:\npublic-read public-read-write aws s3api create-bucket --acl authenticated-read --bucket BUCKET_NAME --region us-east-1 SPL:\n\"requestParameters.x-amz-acl{}\"=\"authenticated-read\" Combining the events under Scenario 2, SPL will look like this:\nindex=\"*\" sourcetype=\"aws:cloudtrail\" eventName=CreateBucket OR eventName=\"Put*Acl\" \"requestParameters.x-amz-acl{}\"=\"public-*\" OR \"requestParameters.x-amz-acl{}\"=\"authenticated-read\" | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index) Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line CLI Command used:\naws s3api create-bucket --bucket BUCKET_NAME --region us-east-1 --grant-write-acp uri=\"http://acs.amazonaws.com/groups/global/AllUsers\" [--grant-full-control ] [--grant-read ] [--grant-read-acp ] [--grant-write ]- [--grant-write-acp ] Here value could be either “http://acs.amazonaws.com/groups/global/AuthenticatedUsers\" OR “http://acs.amazonaws.com/groups/global/AllUsers\"\nReference:\nUsing API-Level (s3api) commands with the AWS CLI\nSPL:\neventName=CreateBucket requestParameters.x-amz-grant-read{}=\"uri=http://acs.amazonaws.com/groups/global/AllUsers\" Combining all the posible values, SPL will look like:\n(requestParameters.x-amz-grant-full-control{}=\"*AllUsers\" OR requestParameters.x-amz-grant-full-control{}=\"*AuthenticatedUsers\")\r(requestParameters.x-amz-grant-read{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read-acp{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write-acp{}=\"*AuthenticatedUsers\") Consolidatig all the above searches, to detect all possible scenarios, our complete search will be:\nindex=\"*\" sourcetype=\"aws:cloudtrail\" eventName=CreateBucket OR eventName=\"Put*Acl\" (\"requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI\"=\"http://acs.amazonaws.com/groups/global/AllUsers\") OR (requestParameters.x-amz-grant-full-control{}=\"*AllUsers\" OR requestParameters.x-amz-grant-full-control{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-read-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-read-acp{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write{}=\"*AuthenticatedUsers\") OR\r(requestParameters.x-amz-grant-write-acp{}=\"*AllUsers\" OR requestParameters.x-amz-grant-write-acp{}=\"*AuthenticatedUsers\") | eval time=strftime(_time,\"%c %p\")\r| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index) If you are importing the S3 Server Access Logs in to Splunk, you can use geostats command to generate statistics to display geographic data and summarize the data on maps.\nindex=\"*\" sourcetype=\"aws:s3:accesslogs\" | iplocation remote_ip\r| geostats count BY remote_ip Known false positives: There could be undesired alerts that can occur from this search, when someone intentionally creates a public bucket. In this case, consider adding speicific buckets to whitelist.\nHow to respond: When this alert fires, ask yourself these questions. Is it still public? This is easy to detect, just search the logs for the bucket name and PutBucketACL, to see any subsequent ACL changes. Are the files public? and What is in it? These can be detected using S3 Access logs.\nHow to prevent: Configure S3 Block Public Access on the AWS account level (applies to all S3 buckets in all regions). S3 Block Public Access provides four settings:\nBlock Public ACLs: Prevent any new operations to make buckets or objects public through Bucket or Object ACLs. (existing policies and ACLs for buckets and objects are not modified.) Ignore Public ACLs: Ignore all public ACLs on a bucket and any objects that it contains Block Public Policy: Reject calls to PUT Bucket policy if the specified bucket policy allows public access. (Enabling this setting doesn’t affect existing bucket policies) Restrict Public Buckets: Restrict access to a bucket with a public policy to only AWS services and authorized users within the bucket owner’s account. provider \"aws\" { } resource \"aws_s3_account_public_access_block\" \"BlockPublicAccess\" { block_public_acls = \"true\" ignore_public_acls = \"true\" block_public_policy = \"true\" restrict_public_buckets = \"true\" } ","wordCount":"754","inLanguage":"en","datePublished":"2020-06-20T00:00:00Z","dateModified":"2020-06-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.logsec.cloud/posts/detect-public-s3-bucket-using-splunk/"},"publisher":{"@type":"Organization","name":"logsec","logo":{"@type":"ImageObject","url":"https://www.logsec.cloud/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.logsec.cloud accesskey=h title="logsec (Alt + H)">logsec</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.logsec.cloud/ title=posts><span>posts</span></a></li><li><a href=https://www.logsec.cloud/pages/about title=about><span>about</span></a></li><li><a href=https://www.logsec.cloud/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.logsec.cloud>Home</a>&nbsp;»&nbsp;<a href=https://www.logsec.cloud/posts/>Posts</a></div><h1 class=post-title>Detect Public S3 Bucket using Splunk</h1><div class=post-meta><span title='2020-06-20 00:00:00 +0000 UTC'>June 20, 2020</span>&nbsp;·&nbsp;4 min</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#scenario-1-using-the-aws-web-console aria-label="Scenario 1: Using the AWS Web Console"><strong>Scenario 1: Using the AWS Web Console</strong></a></li><li><a href=#scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy aria-label="Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:"><strong>Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:</strong></a></li><li><a href=#scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line aria-label="Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line"><strong>Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line</strong></a></li></ul></div></details></div><div class=post-content><p>In today&rsquo;s post, we will learn how to detect a public S3 bucket using Splunk. Later, we will see how we can respond to such incidents and even prevent it from happening in the first place. As you will see in the following examples, there are multiple ways to create a S3 bucket and make it public. Also, for this blog, I created some subdomains of <a href=https://www.logsec.cloud>logsec.cloud</a> in <a href=https://aws.amazon.com/route53/ title="AWS Route 53 Documentation">Route53</a>.</p><h3 id=scenario-1-using-the-aws-web-console><strong>Scenario 1: Using the AWS Web Console</strong><a hidden class=anchor aria-hidden=true href=#scenario-1-using-the-aws-web-console>#</a></h3><p>Create a S3 bucket and Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; -
Access to the objects -</p><ul><li>List Objects [*]: Allows Gurantee to list the objects in the bucket</li><li>Write Objects [*]: Allows Gurantee to create and delete the objects in the bucket</li></ul><p><img loading=lazy src=/images/2020_06_19_1.jpg alt></p><p>Go to &ldquo;Permissions&rdquo; - &ldquo;Access Control List&rdquo; - &ldquo;Public Access&rdquo; - &ldquo;Everyone&rdquo; -
Access to this bucket&rsquo;s ACL -</p><ul><li>Read bucket permissions: Allow Gurantee to read the bucket ACL</li><li>Write bucket permissions: Allow Gurantee to edit the bucket ACL</li></ul><p>To detect the first two scenarios, below Splunk search will work:</p><pre tabindex=0><code>index=&#34;*&#34; sourcetype=&#34;aws:cloudtrail&#34;eventName=CreateBucket OR eventName=PutBucketAcl OR eventName=PutObjectAcl 
    requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=&#34;http://acs.amazonaws.com/groups/global/AllUsers&#34; 
    OR requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI=&#34;http://acs.amazonaws.com/groups/global/AuthenticatedUsers&#34; 
| rename requestParameters.AccessControlPolicy.Owner.DisplayName as bucketOwner  
| eval time=strftime(_time,&#34;%c %p&#34;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><h3 id=scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy><strong>Scenario 2: Using the AWS CLI to create a bucket with a public-read policy:</strong><a hidden class=anchor aria-hidden=true href=#scenario-2-using-the-aws-cli-to-create-a-bucket-with-a-public-read-policy>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ aws s3api create-bucket --acl public-read --bucket BUCKET_NAME --region us-east-1
</span></span></code></pre></div><p>Other Possible values are: [CANNED ACLs]</p><ul><li>private</li><li>public-read</li><li>public-read-write</li><li>authenticated-read</li></ul><p>Reference: <a href=https://docs.aws.amazon.com/cli/latest/reference/s3api/create-bucket.html title="AWS CLI Command Reference">Create-Bucket</a></p><p>Testing the value: authenticated-read: Add the &ldquo;Any AWS User&rdquo; under the Public Access. Even though this option to add Authenticated User is now removed from the AWS Console, but you can still use it using the AWS CLI.</p><p><img loading=lazy src=/images/2020_06_19_2.jpg alt></p><p>SPL:</p><pre tabindex=0><code>&#34;requestParameters.x-amz-acl{}&#34;=&#34;public-*&#34;
</code></pre><p>To detect both values:</p><ul><li>public-read</li><li>public-read-write</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3api create-bucket --acl authenticated-read --bucket BUCKET_NAME --region us-east-1
</span></span></code></pre></div><p>SPL:</p><pre tabindex=0><code>&#34;requestParameters.x-amz-acl{}&#34;=&#34;authenticated-read&#34;
</code></pre><p>Combining the events under Scenario 2, SPL will look like this:</p><pre tabindex=0><code>index=&#34;*&#34; sourcetype=&#34;aws:cloudtrail&#34; eventName=CreateBucket OR eventName=&#34;Put*Acl&#34; &#34;requestParameters.x-amz-acl{}&#34;=&#34;public-*&#34; OR &#34;requestParameters.x-amz-acl{}&#34;=&#34;authenticated-read&#34; 
| eval time=strftime(_time,&#34;%c %p&#34;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><h3 id=scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line><strong>Scenario 3: Another option to make an S3 bucket public: by specifying the Grant ACP permissions via the command line</strong><a hidden class=anchor aria-hidden=true href=#scenario-3-another-option-to-make-an-s3-bucket-public-by-specifying-the-grant-acp-permissions-via-the-command-line>#</a></h3><p>CLI Command used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>aws s3api create-bucket --bucket BUCKET_NAME --region us-east-1 --grant-write-acp uri<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://acs.amazonaws.com/groups/global/AllUsers&#34;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>--grant-full-control &lt;value&gt;<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>--grant-read &lt;value&gt;<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>--grant-read-acp &lt;value&gt;<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>--grant-write &lt;value&gt;<span style=color:#f92672>]</span>- 
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>--grant-write-acp &lt;value&gt;<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>Here <code>value</code> could be either &ldquo;<a href=http://acs.amazonaws.com/groups/global/AuthenticatedUsers%22>http://acs.amazonaws.com/groups/global/AuthenticatedUsers"</a> OR &ldquo;<a href=http://acs.amazonaws.com/groups/global/AllUsers%22>http://acs.amazonaws.com/groups/global/AllUsers"</a></p><p>Reference:<br><a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-services-s3-apicommands.html title="s3 api Documentation">Using API-Level (s3api) commands with the AWS CLI</a></p><p>SPL:</p><pre tabindex=0><code>eventName=CreateBucket requestParameters.x-amz-grant-read{}=&#34;uri=http://acs.amazonaws.com/groups/global/AllUsers&#34;
</code></pre><p>Combining all the posible values, SPL will look like:</p><pre tabindex=0><code>(requestParameters.x-amz-grant-full-control{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-full-control{}=&#34;*AuthenticatedUsers&#34;)
(requestParameters.x-amz-grant-read{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-read{}=&#34;*AuthenticatedUsers&#34;) OR
(requestParameters.x-amz-grant-read-acp{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-read-acp{}=&#34;*AuthenticatedUsers&#34;) OR
(requestParameters.x-amz-grant-write{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-write{}=&#34;*AuthenticatedUsers&#34;) OR
(requestParameters.x-amz-grant-write-acp{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-write-acp{}=&#34;*AuthenticatedUsers&#34;)
</code></pre><hr><p>Consolidatig all the above searches, to detect all possible scenarios, our complete search will be:</p><pre tabindex=0><code>index=&#34;*&#34; sourcetype=&#34;aws:cloudtrail&#34; eventName=CreateBucket OR eventName=&#34;Put*Acl&#34;  
(&#34;requestParameters.AccessControlPolicy.AccessControlList.Grant{}.Grantee.URI&#34;=&#34;http://acs.amazonaws.com/groups/global/AllUsers&#34;) OR  
(requestParameters.x-amz-grant-full-control{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-full-control{}=&#34;*AuthenticatedUsers&#34;) OR
    (requestParameters.x-amz-grant-read{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-read{}=&#34;*AuthenticatedUsers&#34;) OR
    (requestParameters.x-amz-grant-read-acp{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-read-acp{}=&#34;*AuthenticatedUsers&#34;) OR
    (requestParameters.x-amz-grant-write{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-write{}=&#34;*AuthenticatedUsers&#34;) OR
    (requestParameters.x-amz-grant-write-acp{}=&#34;*AllUsers&#34; OR requestParameters.x-amz-grant-write-acp{}=&#34;*AuthenticatedUsers&#34;) 
| eval time=strftime(_time,&#34;%c %p&#34;)
| stats values(time) values(eventSource) values(eventName) values(eventType) values(errorCode) values(requestParameters.bucketName) values(bucketOwner) values(sourceIPAddress) values(userIdentity.arn) values(userIdentity.type) values(awsRegion) values(userIdentity.accountId) values(index)
</code></pre><p>If you are importing the S3 Server Access Logs in to Splunk, you can use <code>geostats</code> command to generate statistics to display geographic data and summarize the data on maps.</p><pre tabindex=0><code>index=&#34;*&#34; sourcetype=&#34;aws:s3:accesslogs&#34; 
| iplocation remote_ip
| geostats count BY remote_ip
</code></pre><p><img loading=lazy src=/images/2020_06_19_3.jpg alt></p><p><strong>Known false positives:</strong> There could be undesired alerts that can occur from this search, when someone intentionally creates a public bucket. In this case, consider adding speicific buckets to whitelist.</p><p><strong>How to respond:</strong> When this alert fires, ask yourself these questions. Is it still public? This is easy to detect, just search the logs for the bucket name and PutBucketACL, to see any subsequent ACL changes. Are the files public? and What is in it? These can be detected using S3 Access logs.</p><p><strong>How to prevent:</strong> Configure S3 Block Public Access on the AWS account level (applies to all S3 buckets in all regions). S3 Block Public Access provides four settings:</p><ul><li><strong>Block Public ACLs</strong>: Prevent any new operations to make buckets or objects public through Bucket or Object ACLs. (existing policies and ACLs for buckets and objects are not modified.)</li><li><strong>Ignore Public ACLs</strong>: Ignore all public ACLs on a bucket and any objects that it contains</li><li><strong>Block Public Policy</strong>: Reject calls to PUT Bucket policy if the specified bucket policy allows public access. (Enabling this setting doesn&rsquo;t affect existing bucket policies)</li><li><strong>Restrict Public Buckets</strong>: Restrict access to a bucket with a public policy to only AWS services and authorized users within the bucket owner&rsquo;s account.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>
</span></span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_account_public_access_block&#34;</span> <span style=color:#e6db74>&#34;BlockPublicAccess&#34;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>block_public_acls</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ignore_public_acls</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>block_public_policy</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>restrict_public_buckets</span> = <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.logsec.cloud/posts/dnscat2-demo-on-aws/><span class=title>« Prev</span><br><span>dnscat2: Command and Control over the DNS</span></a>
<a class=next href=https://www.logsec.cloud/posts/investigating-on-aws/><span class=title>Next »</span><br><span>Investigating S3 Scanning Activites on AWS</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on twitter" href="https://twitter.com/intent/tweet/?text=Detect%20Public%20S3%20Bucket%20using%20Splunk&url=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f&hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f&title=Detect%20Public%20S3%20Bucket%20using%20Splunk&summary=Detect%20Public%20S3%20Bucket%20using%20Splunk&source=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f&title=Detect%20Public%20S3%20Bucket%20using%20Splunk"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on whatsapp" href="https://api.whatsapp.com/send?text=Detect%20Public%20S3%20Bucket%20using%20Splunk%20-%20https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Detect Public S3 Bucket using Splunk on telegram" href="https://telegram.me/share/url?text=Detect%20Public%20S3%20Bucket%20using%20Splunk&url=https%3a%2f%2fwww.logsec.cloud%2fposts%2fdetect-public-s3-bucket-using-splunk%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://giscus.app/client.js data-repo=harwinds/logsec data-repo-id=R_kgDOGjnARg data-category=Announcements data-category-id=DIC_kwDOGjnARs4CAWru data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark data-lang=en crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://www.logsec.cloud>logsec</a></span>
<span>Powered:
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>