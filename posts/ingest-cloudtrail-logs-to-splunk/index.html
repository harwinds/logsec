<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Ingest AWS CloudTrail logs to Splunk | logsec</title>
<meta name=keywords content>
<meta name=description content="This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.
There are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation.">
<meta name=author content>
<link rel=canonical href=https://harwinds.github.io/logsec/posts/ingest-cloudtrail-logs-to-splunk/>
<link crossorigin=anonymous href=/logsec/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/logsec/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=16x16 href=https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E>
<link rel=icon type=image/png sizes=32x32 href=https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E>
<link rel=apple-touch-icon href=https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E>
<link rel=mask-icon href=https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.91.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="Ingest AWS CloudTrail logs to Splunk">
<meta property="og:description" content="This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.
There are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://harwinds.github.io/logsec/posts/ingest-cloudtrail-logs-to-splunk/"><meta property="og:image" content="https://harwinds.github.io/logsec/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-04-20T00:00:00+00:00">
<meta property="article:modified_time" content="2020-04-20T00:00:00+00:00"><meta property="og:site_name" content="ExampleSite">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://harwinds.github.io/logsec/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E">
<meta name=twitter:title content="Ingest AWS CloudTrail logs to Splunk">
<meta name=twitter:description content="This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.
There are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://harwinds.github.io/logsec/posts/"},{"@type":"ListItem","position":3,"name":"Ingest AWS CloudTrail logs to Splunk","item":"https://harwinds.github.io/logsec/posts/ingest-cloudtrail-logs-to-splunk/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Ingest AWS CloudTrail logs to Splunk","name":"Ingest AWS CloudTrail logs to Splunk","description":"This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.\nThere are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation.","keywords":[],"articleBody":"This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.\nThere are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation. For our demo purposes, we will be using Terraform by Hashicorp. Terraform is a tool for building, changing, and versioning infrastrcuture safely and efficiently.\nThis article assumes you have some familiarity with Terraform already.\nAll Terraform files are available to download at my GitHub Repo. You just need to edit the terraform.tfvars file and put your AWS ACCESS KEY ID and SECRET ACCESS KEY.\nmaven@pluto:~$ tree ./terraform/ ./terraform/ ├── cloudtrail.tf ├── module.tf ├── output.tf ├── provider.tf ├── splunk │ ├── instance_splunk.tf │ ├── splunk_iam_role.tf │ ├── splunk_iam_role_pol.json │ ├── user_data_splunk.sh │ ├── variables.tf │ └── vpc_splunk.tf ├── sqs_cloudtrail_logs.tf ├── terraform.tfvars ├── variables.tf └── versions.tf 1.\tCreate an IAM Role for the Splunk Instance and attach a policy which allows EC2 instances to call AWS services on your behalf. resource \"aws_iam_role\" \"splunk_iam_role\" { name = \"splunk_role\" assume_role_policy = { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Action\": \"sts:AssumeRole\", \"Principal\": { \"Service\": \"ec2.amazonaws.com\" }, \"Effect\": \"Allow\", \"Sid\": \"\" } ] } EOF } output \"splunk_iam_role_arn\" { description = \"The ARN of the Role\" value = aws_iam_role.splunk_iam_role.arn } 2. Create an IAM Policy and attach to the Splunk IAM Role with all the required permissions to pull logs from required AWS services. resource \"aws_iam_role_policy\" \"splunk_iam_policy\" { name = \"splunk_policy\" role = aws_iam_role.splunk_iam_role.id policy = file(\"${path.module}/splunk_iam_role_pol.json\") } Example IAM policy which will cover the majority of access splunk should need within AWS. Policy containing permisisons for all inputs is available at Splunk Docs\n{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Action\": [ \"sqs:GetQueueAttributes\", \"sqs:ListQueues\", \"sqs:ReceiveMessage\", \"sqs:GetQueueUrl\", \"sqs:SendMessage\", \"sqs:DeleteMessage\", \"s3:ListBucket\", \"s3:GetObject\", \"s3:GetBucketLocation\", \"s3:ListAllMyBuckets\", \"s3:GetBucketTagging\", \"s3:GetAccelerateConfiguration\", \"s3:GetBucketLogging\", \"s3:GetLifecycleConfiguration\", \"s3:GetBucketCORS\", \"config:DeliverConfigSnapshot\", \"config:DescribeConfigRules\", \"config:DescribeConfigRuleEvaluationStatus\", \"config:GetComplianceDetailsByConfigRule\", \"config:GetComplianceSummaryByConfigRule\", \"iam:GetUser\", \"iam:ListUsers\", \"iam:GetAccountPasswordPolicy\", \"iam:ListAccessKeys\", \"iam:GetAccessKeyLastUsed\", \"autoscaling:Describe*\", \"cloudwatch:Describe*\", \"cloudwatch:Get*\", \"cloudwatch:List*\", \"sns:Get*\", \"sns:List*\", \"sns:Publish\", \"logs:DescribeLogGroups\", \"logs:DescribeLogStreams\", \"logs:GetLogEvents\", \"ec2:DescribeInstances\", \"ec2:DescribeReservedInstances\", \"ec2:DescribeSnapshots\", \"ec2:DescribeRegions\", \"ec2:DescribeKeyPairs\", \"ec2:DescribeNetworkAcls\", \"ec2:DescribeSecurityGroups\", \"ec2:DescribeSubnets\", \"ec2:DescribeVolumes\", \"ec2:DescribeVpcs\", \"ec2:DescribeImages\", \"ec2:DescribeAddresses\", \"lambda:ListFunctions\", \"rds:DescribeDBInstances\", \"cloudfront:ListDistributions\", \"elasticloadbalancing:DescribeLoadBalancers\", \"elasticloadbalancing:DescribeInstanceHealth\", \"elasticloadbalancing:DescribeTags\", \"elasticloadbalancing:DescribeTargetGroups\", \"elasticloadbalancing:DescribeTargetHealth\", \"elasticloadbalancing:DescribeListeners\", \"inspector:Describe*\", \"inspector:List*\", \"kinesis:Get*\", \"kinesis:DescribeStream\", \"kinesis:ListStreams\", \"kms:Decrypt\", \"sts:AssumeRole\" ], \"Resource\": [ \"*\" ] } ] } 3. Create an IAM instance profile for Splunk Instance. resource \"aws_iam_instance_profile\" \"splunk_instance_profile\" { name = \"splunk_instance_profile\" role = aws_iam_role.splunk_iam_role.name } output \"splunk_instance_profile_name\" { description = \"The instance profile's name\" value = aws_iam_instance_profile.splunk_instance_profile.name } 4. Create a CloudTrail for your AWS Account. You can create up to five trails for each region. After you create a trail, CloudTrail automatically starts logging API calls and related events in your account to the Amazon S3 bucket that you specify. To stop logging, you can turn off logging for the trail or delete it.\nresource \"aws_cloudtrail\" \"lab_trail\" { name = \"lab_trail\" s3_bucket_name = aws_s3_bucket.trail_bucket.id include_global_service_events = false is_multi_region_trail = false } output \"lab_trail_id\" { description = \"The name of the trail\" value = aws_cloudtrail.lab_trail.id } output \"lab_trail_region\" { description = \"The region in which the trail was created\" value = aws_cloudtrail.lab_trail.home_region } 5. Create an Amazon S3 bucket for our CloudTrail. resource \"aws_s3_bucket\" \"trail_bucket\" { bucket = \"${data.aws_caller_identity.current.account_id}-lab-cloudtrail-logs\" force_destroy = true policy = { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"AWSbucketAclCheck\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:GetBucketAcl\", \"Resource\": \"arn:aws:s3:::${data.aws_caller_identity.current.account_id}-lab-cloudtrail-logs\" }, { \"Sid\": \"AWSbucketWrite\", \"Effect\": \"Allow\", \"Principal\": { \"Service\": \"cloudtrail.amazonaws.com\" }, \"Action\": \"s3:PutObject\", \"Resource\": \"arn:aws:s3:::${data.aws_caller_identity.current.account_id}-lab-cloudtrail-logs/AWSLogs/${data.aws_caller_identity.current.account_id}/*\", \"Condition\": { \"StringEquals\": { \"s3:x-amz-acl\": \"bucket-owner-full-control\" } } } ] } POLICY } output \"trail_bucket_id\" { description = \"The name of the bucket\" value = aws_s3_bucket.trail_bucket.id } output \"trail_bucket_region\" { description = \"The ARN of the bucket\" value = aws_s3_bucket.trail_bucket.arn } 6. Create two SQS Queues. Now it’s time to create the SQS queues. Two queues will be required. One queue will be the dead letter queue for error messages to be kicked over to and the other will be the queue used to capture the S3 notifications when a new Cloud trail event is sent to the S3 bucket we created in earlier step.\n# Add Amazon S3 Event Notification configuration to SQS Queue resource \"aws_sqs_queue\" \"queue\" { name = \"s3_event_notification_queue\" visibility_timeout_seconds = 300 redrive_policy = jsonencode({ deadLetterTargetArn = aws_sqs_queue.dl_queue.arn maxReceiveCount = 1 }) policy = { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": \"*\", \"Action\": \"sqs:SendMessage\", \"Resource\": \"arn:aws:sqs:*:*:s3_event_notification_queue\", \"Condition\": { \"ArnEquals\": { \"aws:SourceArn\": \"${aws_s3_bucket.trail_bucket.arn}\" } } } ] } POLICY }# Set up a dead-letter queue for the SQS queue to be used for the input for storing invalid messages resource \"aws_sqs_queue\" \"dl_queue\" { name = \"dl_queue_error_messages\" } resource \"aws_s3_bucket_notification\" \"bucket_notification\" { bucket = aws_s3_bucket.trail_bucket.id queue { queue_arn = aws_sqs_queue.queue.arn events = [\"s3:ObjectCreated:*\"] } } output \"sqs_arn\" { description = \"The ARN of the SQS queue\" value = aws_sqs_queue.queue.arn } 7. Create an Amazon VPC for our Splunk Splunk Instance Please note this step is not mandatory, you can use the default VPC as well. In this step we will demonstate how to setup our own VPC, a public subnet, an Internet Gateway along with a route table.\n# VPC resource \"aws_vpc\" \"splunk_vpc\" { cidr_block = \"192.168.0.0/24\" enable_dns_hostnames = \"true\" instance_tenancy = \"default\" tags = { Name = \"splunk_vpc\" } } output \"splunk_vpc_arn\" { description = \"The ARN of the VPC\" value = aws_vpc.splunk_vpc.arn } output \"splunk_vpc_id\" { description = \"The ID of the VPC\" value = aws_vpc.splunk_vpc.id }# Public Subnet resource \"aws_subnet\" \"splunk_subnet_public\" { vpc_id = aws_vpc.splunk_vpc.id cidr_block = \"192.168.0.0/24\" map_public_ip_on_launch = \"true\" availability_zone = \"us-east-1a\" tags = { Name = \"splunk_subnet_public\" } } output \"splunk_subnet_public\" { description = \"The ID of the public subnet\" value = aws_subnet.splunk_subnet_public.id }# Internet GW resource \"aws_internet_gateway\" \"splunk_gw\" { vpc_id = aws_vpc.splunk_vpc.id tags = { Name = \"splunk_gw\" } } output \"splunk_gw\" { description = \"The ID of the IGW\" value = aws_internet_gateway.splunk_gw.id }# Route Table resource \"aws_route_table\" \"splunk_route_table\" { vpc_id = aws_vpc.splunk_vpc.id route { cidr_block = \"0.0.0.0/0\" gateway_id = aws_internet_gateway.splunk_gw.id } tags = { Name = \"splunk_route_table\" } } output \"splunk_route_table\" { description = \"The ID of the routing table\" value = aws_route_table.splunk_route_table.id }# Associate Route Table and Subnet resource \"aws_route_table_association\" \"splunk_route_table_subnet_public\" { subnet_id = aws_subnet.splunk_subnet_public.id route_table_id = aws_route_table.splunk_route_table.id } 8. Create an EC2 Instance of the latest Ubuntu 18.04 on a t2.medium node. Now, let’s create an instance where we will use the user_data argument to pass our bash script which will download and install Splunk Enterprise for us.\ndata \"aws_ami\" \"ubuntu_server\" { most_recent = true owners = [\"099720109477\"]# Canonical  filter { name = \"name\" values = [\"ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*\"] } filter { name = \"virtualization-type\" values = [\"hvm\"] } } resource \"aws_instance\" \"splunk_instance\" { ami = data.aws_ami.ubuntu_server.id iam_instance_profile = aws_iam_instance_profile.splunk_instance_profile.name instance_type = \"t2.medium\" key_name = \"lab_kp\"# VPC  subnet_id = aws_subnet.splunk_subnet_public.id# SG  vpc_security_group_ids = [aws_security_group.splunk_sg.id] root_block_device { volume_type = \"gp2\" volume_size = 16 } user_data = file(\"${path.module}/user_data_splunk.sh\") tags = { Name = \"splunk\" } } output \"splunk_instance_id\" { description = \"Instance ID\" value = aws_instance.splunk_instance.id } output \"splunk_instance_public_ip\" { description = \"Public IP\" value = aws_instance.splunk_instance.public_ip } output \"splunk_instance_private_ip\" { description = \"Private IP\" value = aws_instance.splunk_instance.private_ip }# SG resource \"aws_security_group\" \"splunk_sg\" { description = \"Allow SSH inbound traffic\" vpc_id = aws_vpc.splunk_vpc.id ingress { description = \"Splunk Port 8000 from Home Netowrk\" from_port = 8000 to_port = 8000 protocol = \"tcp\" cidr_blocks = [\"${var.home_ip}/32\"] } ingress { description = \"SSH from Home Netowrk\" from_port = 22 to_port = 22 protocol = \"tcp\" cidr_blocks = [\"${var.home_ip}/32\"] } egress { from_port = 0 to_port = 0 protocol = \"-1\" cidr_blocks = [\"0.0.0.0/0\"] } tags = { Name = \"splunk_sg\" } } output \"splunk_sg\" { description = \"The ID of the security group\" value = aws_security_group.splunk_sg.id } User Data: When you install Splunk Enterprise, you must create a username and password for your administrator account. We will create admin credentials using the --gen-and-print-passwd CLI arguments.\n#! /bin/bash -xe exec  (tee /var/log/user-data.log|logger -t user-data -s 2/dev/console) 2\u00261 echo BEGIN sudo apt-get update sudo apt-get upgrade -y cd /tmp \u0026\u0026 wget -O splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb 'https://www.splunk.com/bin/splunk/DownloadActivityServlet?architecture=x86_64\u0026platform=linux\u0026version=8.0.3\u0026product=splunk\u0026filename=splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb\u0026wget=true' cd /opt sudo dpkg -i /tmp/splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb cd splunk/ /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt --gen-and-print-passwd echo END 9. Login to Splunk Instance using the public IP of the EC2 instance Browse to http://public_ip:8000\nusername: admin\npassword: You need to grab from the file /var/log/user-data.log\nIt will be randomly generated as we used the option --gen-and-print-passwd\n10. Install these two apps on the Splunk Instance.  Splunk Add-on for Amazon Web Services Splunk App for AWS  Once the apps are installed, restart Splunk.\n11. Go to App: Splunk Add-on for AWS and go under the “Configuration” tab, you’ll see Role Assigned to the Splunk instance will populate in a couple of seconds. 12. Go to “Inputs” tab Create a New Input selectng Data Type CloudTrail and Input Type SQS-Based S3\n13. Fill out the AWS Input Configuration details  Please note under the AWS Account, name of the role assigned to the Instance will automatically show up. For the SQS Queue Name, you will see two SQS queues we created in earlier post. Please select the Event Notification Queue. For the Index, either you can create a new index for CloudTrail logs or using existing one.  14. Go to Search \u0026 Reporting App Search for the CloudTrail logs using the SPL:\nindex=main sourcetype=\"aws:cloudtrail\"\r| table _time eventSource eventName eventType errorCode awsRegion userIdentity.accountId\r Summary: In this post, we learnt how to setup up a Splunk environment on AWS for lab purposes. We used Terraform to setup the AWS environment and then manually configured Splunk to integrate the CloudTrail logs.\n References  https://docs.splunk.com/Documentation/Splunk/latest/Security/Secureyouradminaccount#Create_admin_credentials_after_starting_Splunk_Enterprise https://docs.splunk.com/Documentation/AddOns/released/AWS/Setuptheadd-on  ","wordCount":"1601","inLanguage":"en","datePublished":"2020-04-20T00:00:00Z","dateModified":"2020-04-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://harwinds.github.io/logsec/posts/ingest-cloudtrail-logs-to-splunk/"},"publisher":{"@type":"Organization","name":"logsec","logo":{"@type":"ImageObject","url":"https://harwinds.github.io/logsec/%3Clink%20/%20abs%20url%3E"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://harwinds.github.io/logsec accesskey=h title="logsec (Alt + H)">logsec</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://harwinds.github.io/logsec/pages/about title=about>
<span>about</span>
</a>
</li>
<li>
<a href=https://harwinds.github.io/logsec/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=https://harwinds.github.io/logsec/search/ title=search>
<span>search</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://harwinds.github.io/logsec>Home</a>&nbsp;»&nbsp;<a href=https://harwinds.github.io/logsec/posts/>Posts</a></div>
<h1 class=post-title>
Ingest AWS CloudTrail logs to Splunk
</h1>
<div class=post-meta><span title="2020-04-20 00:00:00 +0000 UTC">April 20, 2020</span>&nbsp;·&nbsp;8 min
</div>
</header>
<div class=post-content><p>This blog post will walk you through setting up a Splunk environment on AWS for lab purposes using Splunk Enterprise Free 60-day trail. After 60 days you can convert to a perpetual free license or purchase a Splunk Enterprise license to continue using the expanded functionality designed for enterprise-scale deployments. There is an indexing limit of 500 MB/Day which will be more than enough for our demo purposes.</p>
<p><img loading=lazy src=/images/2020_04_20_0.png alt>
</p>
<p>There are multiple ways to accomplish this - using AWS Console, CLI or using CloudFormation. For our demo purposes, we will be using <a href=https://www.terraform.io/>Terraform by Hashicorp</a>. Terraform is a tool for building, changing, and versioning infrastrcuture safely and efficiently.</p>
<p>This article assumes you have some familiarity with Terraform already.</p>
<p>All Terraform files are available to download at my <a href=https://github.com/harwinds/logsec_blog_code>GitHub Repo</a>. You just need to edit the <code>terraform.tfvars</code> file and put your AWS <code>ACCESS KEY ID</code> and <code>SECRET ACCESS KEY</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>maven@pluto:~$ tree ./terraform/
./terraform/
├── cloudtrail.tf
├── module.tf
├── output.tf
├── provider.tf
├── splunk
│   ├── instance_splunk.tf
│   ├── splunk_iam_role.tf
│   ├── splunk_iam_role_pol.json
│   ├── user_data_splunk.sh
│   ├── variables.tf
│   └── vpc_splunk.tf
├── sqs_cloudtrail_logs.tf
├── terraform.tfvars
├── variables.tf
└── versions.tf
</code></pre></div><h3 id=1create-an-iam-role-for-the-splunk-instance-and-attach-a-policy-which-allows-ec2-instances-to-call-aws-services-on-your-behalf>1. Create an IAM Role for the Splunk Instance and attach a policy which allows EC2 instances to call AWS services on your behalf.<a hidden class=anchor aria-hidden=true href=#1create-an-iam-role-for-the-splunk-instance-and-attach-a-policy-which-allows-ec2-instances-to-call-aws-services-on-your-behalf>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role&#34;</span> <span style=color:#e6db74>&#34;splunk_iam_role&#34;</span> {
  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;splunk_role&#34;</span>

  <span style=color:#a6e22e>assume_role_policy</span> = <span style=color:#f92672>&lt;&lt;EOF</span><span style=color:#e6db74>
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span><span style=color:#e6db74>    {
</span><span style=color:#e6db74>      &#34;Action&#34;: &#34;sts:AssumeRole&#34;,
</span><span style=color:#e6db74>      &#34;Principal&#34;: {
</span><span style=color:#e6db74>        &#34;Service&#34;: &#34;ec2.amazonaws.com&#34;
</span><span style=color:#e6db74>      },
</span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style=color:#e6db74>      &#34;Sid&#34;: &#34;&#34;
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  ]
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74></span><span style=color:#f92672>EOF</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_iam_role_arn&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ARN of the Role&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>splunk_iam_role</span>.<span style=color:#a6e22e>arn</span>
}
</code></pre></div><h3 id=2-create-an-iam-policy-and-attach-to-the-splunk-iam-role-with-all-the-required-permissions-to-pull-logs-from-required-aws-services>2. Create an IAM Policy and attach to the Splunk IAM Role with all the required permissions to pull logs from required AWS services.<a hidden class=anchor aria-hidden=true href=#2-create-an-iam-policy-and-attach-to-the-splunk-iam-role-with-all-the-required-permissions-to-pull-logs-from-required-aws-services>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_role_policy&#34;</span> <span style=color:#e6db74>&#34;splunk_iam_policy&#34;</span> {
  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;splunk_policy&#34;</span>
  <span style=color:#a6e22e>role</span> = <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>splunk_iam_role</span>.<span style=color:#a6e22e>id</span>

  <span style=color:#a6e22e>policy</span> = file(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span>.module<span style=color:#e6db74>}</span><span style=color:#e6db74>/splunk_iam_role_pol.json&#34;</span>)
}
</code></pre></div><p>Example IAM policy which will cover the majority of access splunk should need within AWS. Policy containing permisisons for all inputs is available at <a href=https://docs.splunk.com/Documentation/AddOns/released/AWS/ConfigureAWSpermissions>Splunk Docs</a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#e6db74>&#34;2012-10-17&#34;</span>,
  <span style=color:#f92672>&#34;Statement&#34;</span>: [
    {
      <span style=color:#f92672>&#34;Effect&#34;</span>: <span style=color:#e6db74>&#34;Allow&#34;</span>,
      <span style=color:#f92672>&#34;Action&#34;</span>: [
        <span style=color:#e6db74>&#34;sqs:GetQueueAttributes&#34;</span>,
        <span style=color:#e6db74>&#34;sqs:ListQueues&#34;</span>,
        <span style=color:#e6db74>&#34;sqs:ReceiveMessage&#34;</span>,
        <span style=color:#e6db74>&#34;sqs:GetQueueUrl&#34;</span>,
        <span style=color:#e6db74>&#34;sqs:SendMessage&#34;</span>,
        <span style=color:#e6db74>&#34;sqs:DeleteMessage&#34;</span>,
        <span style=color:#e6db74>&#34;s3:ListBucket&#34;</span>,
        <span style=color:#e6db74>&#34;s3:GetObject&#34;</span>,
        <span style=color:#e6db74>&#34;s3:GetBucketLocation&#34;</span>,
        <span style=color:#e6db74>&#34;s3:ListAllMyBuckets&#34;</span>,
        <span style=color:#e6db74>&#34;s3:GetBucketTagging&#34;</span>, 
        <span style=color:#e6db74>&#34;s3:GetAccelerateConfiguration&#34;</span>, 
        <span style=color:#e6db74>&#34;s3:GetBucketLogging&#34;</span>, 
        <span style=color:#e6db74>&#34;s3:GetLifecycleConfiguration&#34;</span>, 
        <span style=color:#e6db74>&#34;s3:GetBucketCORS&#34;</span>,
        <span style=color:#e6db74>&#34;config:DeliverConfigSnapshot&#34;</span>,
        <span style=color:#e6db74>&#34;config:DescribeConfigRules&#34;</span>,
        <span style=color:#e6db74>&#34;config:DescribeConfigRuleEvaluationStatus&#34;</span>,
        <span style=color:#e6db74>&#34;config:GetComplianceDetailsByConfigRule&#34;</span>,
        <span style=color:#e6db74>&#34;config:GetComplianceSummaryByConfigRule&#34;</span>,
        <span style=color:#e6db74>&#34;iam:GetUser&#34;</span>,
        <span style=color:#e6db74>&#34;iam:ListUsers&#34;</span>,
        <span style=color:#e6db74>&#34;iam:GetAccountPasswordPolicy&#34;</span>,
        <span style=color:#e6db74>&#34;iam:ListAccessKeys&#34;</span>,
        <span style=color:#e6db74>&#34;iam:GetAccessKeyLastUsed&#34;</span>, 
        <span style=color:#e6db74>&#34;autoscaling:Describe*&#34;</span>,
        <span style=color:#e6db74>&#34;cloudwatch:Describe*&#34;</span>,
        <span style=color:#e6db74>&#34;cloudwatch:Get*&#34;</span>,
        <span style=color:#e6db74>&#34;cloudwatch:List*&#34;</span>,
        <span style=color:#e6db74>&#34;sns:Get*&#34;</span>,
        <span style=color:#e6db74>&#34;sns:List*&#34;</span>,
        <span style=color:#e6db74>&#34;sns:Publish&#34;</span>,
        <span style=color:#e6db74>&#34;logs:DescribeLogGroups&#34;</span>,
        <span style=color:#e6db74>&#34;logs:DescribeLogStreams&#34;</span>,
        <span style=color:#e6db74>&#34;logs:GetLogEvents&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeInstances&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeReservedInstances&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeSnapshots&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeRegions&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeKeyPairs&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeNetworkAcls&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeSecurityGroups&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeSubnets&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeVolumes&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeVpcs&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeImages&#34;</span>,
        <span style=color:#e6db74>&#34;ec2:DescribeAddresses&#34;</span>,
        <span style=color:#e6db74>&#34;lambda:ListFunctions&#34;</span>,
        <span style=color:#e6db74>&#34;rds:DescribeDBInstances&#34;</span>,
        <span style=color:#e6db74>&#34;cloudfront:ListDistributions&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeLoadBalancers&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeInstanceHealth&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeTags&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeTargetGroups&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeTargetHealth&#34;</span>,
        <span style=color:#e6db74>&#34;elasticloadbalancing:DescribeListeners&#34;</span>,
        <span style=color:#e6db74>&#34;inspector:Describe*&#34;</span>,
        <span style=color:#e6db74>&#34;inspector:List*&#34;</span>,
        <span style=color:#e6db74>&#34;kinesis:Get*&#34;</span>,
        <span style=color:#e6db74>&#34;kinesis:DescribeStream&#34;</span>,
        <span style=color:#e6db74>&#34;kinesis:ListStreams&#34;</span>,
        <span style=color:#e6db74>&#34;kms:Decrypt&#34;</span>,
        <span style=color:#e6db74>&#34;sts:AssumeRole&#34;</span>
      ],
      <span style=color:#f92672>&#34;Resource&#34;</span>: [
        <span style=color:#e6db74>&#34;*&#34;</span>
      ]
    }
  ]
}
</code></pre></div><h3 id=3-create-an-iam-instance-profile-for-splunk-instance>3. Create an IAM instance profile for Splunk Instance.<a hidden class=anchor aria-hidden=true href=#3-create-an-iam-instance-profile-for-splunk-instance>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_iam_instance_profile&#34;</span> <span style=color:#e6db74>&#34;splunk_instance_profile&#34;</span> {
  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;splunk_instance_profile&#34;</span>
  <span style=color:#a6e22e>role</span> = <span style=color:#a6e22e>aws_iam_role</span>.<span style=color:#a6e22e>splunk_iam_role</span>.<span style=color:#a6e22e>name</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_instance_profile_name&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The instance profile&#39;s name&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_iam_instance_profile</span>.<span style=color:#a6e22e>splunk_instance_profile</span>.<span style=color:#a6e22e>name</span>
}
</code></pre></div><h3 id=4-create-a-cloudtrail-for-your-aws-account>4. Create a CloudTrail for your AWS Account.<a hidden class=anchor aria-hidden=true href=#4-create-a-cloudtrail-for-your-aws-account>#</a></h3>
<p>You can create up to five trails for each region. After you create a trail, CloudTrail automatically starts logging API calls and related events in your account to the Amazon S3 bucket that you specify. To stop logging, you can turn off logging for the trail or delete it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_cloudtrail&#34;</span> <span style=color:#e6db74>&#34;lab_trail&#34;</span> {
  <span style=color:#a6e22e>name</span>                          = <span style=color:#e6db74>&#34;lab_trail&#34;</span>
  <span style=color:#a6e22e>s3_bucket_name</span>                = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>trail_bucket</span>.<span style=color:#a6e22e>id</span>
  <span style=color:#a6e22e>include_global_service_events</span> = <span style=color:#66d9ef>false</span>
  <span style=color:#a6e22e>is_multi_region_trail</span>         = <span style=color:#66d9ef>false</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;lab_trail_id&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The name of the trail&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_cloudtrail</span>.<span style=color:#a6e22e>lab_trail</span>.<span style=color:#a6e22e>id</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;lab_trail_region&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The region in which the trail was created&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_cloudtrail</span>.<span style=color:#a6e22e>lab_trail</span>.<span style=color:#a6e22e>home_region</span>
}
</code></pre></div><h3 id=5-create-an-amazon-s3-bucket-for-our-cloudtrail>5. Create an Amazon S3 bucket for our CloudTrail.<a hidden class=anchor aria-hidden=true href=#5-create-an-amazon-s3-bucket-for-our-cloudtrail>#</a></h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket&#34;</span> <span style=color:#e6db74>&#34;trail_bucket&#34;</span> {
  <span style=color:#a6e22e>bucket</span>        = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>data.<span style=color:#a6e22e>aws_caller_identity</span>.<span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>account_id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>-lab-cloudtrail-logs&#34;</span>
  <span style=color:#a6e22e>force_destroy</span> = <span style=color:#66d9ef>true</span>

  <span style=color:#a6e22e>policy</span> = <span style=color:#f92672>&lt;&lt;POLICY</span><span style=color:#e6db74>
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>    &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style=color:#e6db74>    &#34;Statement&#34;: [
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>            &#34;Sid&#34;: &#34;AWSbucketAclCheck&#34;,
</span><span style=color:#e6db74>            &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style=color:#e6db74>            &#34;Principal&#34;: {
</span><span style=color:#e6db74>              &#34;Service&#34;: &#34;cloudtrail.amazonaws.com&#34;
</span><span style=color:#e6db74>            },
</span><span style=color:#e6db74>            &#34;Action&#34;: &#34;s3:GetBucketAcl&#34;,
</span><span style=color:#e6db74>            &#34;Resource&#34;: &#34;arn:aws:s3:::${data.aws_caller_identity.current.account_id}-lab-cloudtrail-logs&#34;
</span><span style=color:#e6db74>        },
</span><span style=color:#e6db74>        {
</span><span style=color:#e6db74>            &#34;Sid&#34;: &#34;AWSbucketWrite&#34;,
</span><span style=color:#e6db74>            &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style=color:#e6db74>            &#34;Principal&#34;: {
</span><span style=color:#e6db74>              &#34;Service&#34;: &#34;cloudtrail.amazonaws.com&#34;
</span><span style=color:#e6db74>            },
</span><span style=color:#e6db74>            &#34;Action&#34;: &#34;s3:PutObject&#34;,
</span><span style=color:#e6db74>            &#34;Resource&#34;: &#34;arn:aws:s3:::${data.aws_caller_identity.current.account_id}-lab-cloudtrail-logs/AWSLogs/${data.aws_caller_identity.current.account_id}/*&#34;,
</span><span style=color:#e6db74>            &#34;Condition&#34;: {
</span><span style=color:#e6db74>                &#34;StringEquals&#34;: {
</span><span style=color:#e6db74>                    &#34;s3:x-amz-acl&#34;: &#34;bucket-owner-full-control&#34;
</span><span style=color:#e6db74>                }
</span><span style=color:#e6db74>            }
</span><span style=color:#e6db74>        }
</span><span style=color:#e6db74>    ]
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74></span><span style=color:#f92672>POLICY</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;trail_bucket_id&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The name of the bucket&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>trail_bucket</span>.<span style=color:#a6e22e>id</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;trail_bucket_region&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ARN of the bucket&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>trail_bucket</span>.<span style=color:#a6e22e>arn</span>
}
</code></pre></div><h3 id=6-create-two-sqs-queues>6. Create two SQS Queues.<a hidden class=anchor aria-hidden=true href=#6-create-two-sqs-queues>#</a></h3>
<p>Now it&rsquo;s time to create the SQS queues. Two queues will be required. One queue will be the dead letter queue for error messages to be kicked over to and the other will be the queue used to capture the S3 notifications when a new Cloud trail event is sent to the S3 bucket we created in earlier step.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#75715e># Add Amazon S3 Event Notification configuration to SQS Queue
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_sqs_queue&#34;</span> <span style=color:#e6db74>&#34;queue&#34;</span> {
  <span style=color:#a6e22e>name</span>                       = <span style=color:#e6db74>&#34;s3_event_notification_queue&#34;</span>
  <span style=color:#a6e22e>visibility_timeout_seconds</span> = <span style=color:#ae81ff>300</span>
  <span style=color:#a6e22e>redrive_policy</span> = jsonencode({
    <span style=color:#a6e22e>deadLetterTargetArn</span> = <span style=color:#a6e22e>aws_sqs_queue</span>.<span style=color:#a6e22e>dl_queue</span>.<span style=color:#a6e22e>arn</span>
    <span style=color:#a6e22e>maxReceiveCount</span>     = <span style=color:#ae81ff>1</span>
  })

  <span style=color:#a6e22e>policy</span> = <span style=color:#f92672>&lt;&lt;POLICY</span><span style=color:#e6db74>
</span><span style=color:#e6db74>{
</span><span style=color:#e6db74>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span><span style=color:#e6db74>  &#34;Statement&#34;: [
</span><span style=color:#e6db74>    {
</span><span style=color:#e6db74>      &#34;Effect&#34;: &#34;Allow&#34;,
</span><span style=color:#e6db74>      &#34;Principal&#34;: &#34;*&#34;,
</span><span style=color:#e6db74>      &#34;Action&#34;: &#34;sqs:SendMessage&#34;,
</span><span style=color:#e6db74>      &#34;Resource&#34;: &#34;arn:aws:sqs:*:*:s3_event_notification_queue&#34;,
</span><span style=color:#e6db74>      &#34;Condition&#34;: {
</span><span style=color:#e6db74>        &#34;ArnEquals&#34;: { &#34;aws:SourceArn&#34;: &#34;${aws_s3_bucket.trail_bucket.arn}&#34; }
</span><span style=color:#e6db74>      }
</span><span style=color:#e6db74>    }
</span><span style=color:#e6db74>  ]
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74></span><span style=color:#f92672>POLICY</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Set up a dead-letter queue for the SQS queue to be used for the input for storing invalid messages
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_sqs_queue&#34;</span> <span style=color:#e6db74>&#34;dl_queue&#34;</span> {
  <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;dl_queue_error_messages&#34;</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_s3_bucket_notification&#34;</span> <span style=color:#e6db74>&#34;bucket_notification&#34;</span> {
  <span style=color:#a6e22e>bucket</span> = <span style=color:#a6e22e>aws_s3_bucket</span>.<span style=color:#a6e22e>trail_bucket</span>.<span style=color:#a6e22e>id</span>

  <span style=color:#a6e22e>queue</span> {
    <span style=color:#a6e22e>queue_arn</span> = <span style=color:#a6e22e>aws_sqs_queue</span>.<span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>arn</span>
    <span style=color:#a6e22e>events</span>    = [<span style=color:#e6db74>&#34;s3:ObjectCreated:*&#34;</span>]
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;sqs_arn&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ARN of the SQS queue&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_sqs_queue</span>.<span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>arn</span>
}

</code></pre></div><h3 id=7-create-an-amazon-vpc-for-our-splunk-splunk-instance>7. Create an Amazon VPC for our Splunk Splunk Instance<a hidden class=anchor aria-hidden=true href=#7-create-an-amazon-vpc-for-our-splunk-splunk-instance>#</a></h3>
<p>Please note this step is not mandatory, you can use the default VPC as well. In this step we will demonstate how to setup our
own VPC, a public subnet, an Internet Gateway along with a route table.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#75715e># VPC
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_vpc&#34;</span> <span style=color:#e6db74>&#34;splunk_vpc&#34;</span> {
  <span style=color:#a6e22e>cidr_block</span> = <span style=color:#e6db74>&#34;192.168.0.0/24&#34;</span>
  <span style=color:#a6e22e>enable_dns_hostnames</span> = <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#a6e22e>instance_tenancy</span> = <span style=color:#e6db74>&#34;default&#34;</span>

  <span style=color:#a6e22e>tags</span> = {
    <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk_vpc&#34;</span>
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_vpc_arn&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ARN of the VPC&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>arn</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_vpc_id&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ID of the VPC&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>id</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Public Subnet
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_subnet&#34;</span> <span style=color:#e6db74>&#34;splunk_subnet_public&#34;</span> {
  <span style=color:#a6e22e>vpc_id</span>                  = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>id</span>
  <span style=color:#a6e22e>cidr_block</span>              = <span style=color:#e6db74>&#34;192.168.0.0/24&#34;</span>
  <span style=color:#a6e22e>map_public_ip_on_launch</span> = <span style=color:#e6db74>&#34;true&#34;</span>
  <span style=color:#a6e22e>availability_zone</span>    = <span style=color:#e6db74>&#34;us-east-1a&#34;</span>

  <span style=color:#a6e22e>tags</span> = {
    <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk_subnet_public&#34;</span>
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_subnet_public&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ID of the public subnet&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_subnet</span>.<span style=color:#a6e22e>splunk_subnet_public</span>.<span style=color:#a6e22e>id</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Internet GW
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_internet_gateway&#34;</span> <span style=color:#e6db74>&#34;splunk_gw&#34;</span> {
  <span style=color:#a6e22e>vpc_id</span> = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>id</span>

  <span style=color:#a6e22e>tags</span> = {
    <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk_gw&#34;</span>
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_gw&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ID of the IGW&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_internet_gateway</span>.<span style=color:#a6e22e>splunk_gw</span>.<span style=color:#a6e22e>id</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Route Table
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table&#34;</span> <span style=color:#e6db74>&#34;splunk_route_table&#34;</span> {
  <span style=color:#a6e22e>vpc_id</span> = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>id</span>

  <span style=color:#a6e22e>route</span> {
    <span style=color:#a6e22e>cidr_block</span> = <span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>
    <span style=color:#a6e22e>gateway_id</span> = <span style=color:#a6e22e>aws_internet_gateway</span>.<span style=color:#a6e22e>splunk_gw</span>.<span style=color:#a6e22e>id</span>
  }

  <span style=color:#a6e22e>tags</span> = {
    <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk_route_table&#34;</span>
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_route_table&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ID of the routing table&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_route_table</span>.<span style=color:#a6e22e>splunk_route_table</span>.<span style=color:#a6e22e>id</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># Associate Route Table and Subnet
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route_table_association&#34;</span> <span style=color:#e6db74>&#34;splunk_route_table_subnet_public&#34;</span> {
  <span style=color:#a6e22e>subnet_id</span>      = <span style=color:#a6e22e>aws_subnet</span>.<span style=color:#a6e22e>splunk_subnet_public</span>.<span style=color:#a6e22e>id</span>
  <span style=color:#a6e22e>route_table_id</span> = <span style=color:#a6e22e>aws_route_table</span>.<span style=color:#a6e22e>splunk_route_table</span>.<span style=color:#a6e22e>id</span>
}

</code></pre></div><h3 id=8-create-an-ec2-instance-of-the-latest-ubuntu-1804-on-a-t2medium-node>8. Create an EC2 Instance of the latest Ubuntu 18.04 on a t2.medium node.<a hidden class=anchor aria-hidden=true href=#8-create-an-ec2-instance-of-the-latest-ubuntu-1804-on-a-t2medium-node>#</a></h3>
<p>Now, let&rsquo;s create an instance where we will use the <code>user_data</code> argument to pass our bash script which will download
and install Splunk Enterprise for us.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_ami&#34;</span> <span style=color:#e6db74>&#34;ubuntu_server&#34;</span> {
  <span style=color:#a6e22e>most_recent</span> = <span style=color:#66d9ef>true</span>
  <span style=color:#a6e22e>owners</span> = [<span style=color:#e6db74>&#34;099720109477&#34;</span>]<span style=color:#75715e> # Canonical
</span><span style=color:#75715e></span>
  <span style=color:#a6e22e>filter</span> {
    <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;name&#34;</span>
    <span style=color:#a6e22e>values</span> = [<span style=color:#e6db74>&#34;ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*&#34;</span>]
  }

  <span style=color:#a6e22e>filter</span> {
    <span style=color:#a6e22e>name</span> = <span style=color:#e6db74>&#34;virtualization-type&#34;</span>
    <span style=color:#a6e22e>values</span> = [<span style=color:#e6db74>&#34;hvm&#34;</span>]
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_instance&#34;</span> <span style=color:#e6db74>&#34;splunk_instance&#34;</span> {
   <span style=color:#a6e22e>ami</span> = data.<span style=color:#a6e22e>aws_ami</span>.<span style=color:#a6e22e>ubuntu_server</span>.<span style=color:#a6e22e>id</span>
   <span style=color:#a6e22e>iam_instance_profile</span> = <span style=color:#a6e22e>aws_iam_instance_profile</span>.<span style=color:#a6e22e>splunk_instance_profile</span>.<span style=color:#a6e22e>name</span>
   <span style=color:#a6e22e>instance_type</span> = <span style=color:#e6db74>&#34;t2.medium&#34;</span>
   <span style=color:#a6e22e>key_name</span> = <span style=color:#e6db74>&#34;lab_kp&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>   # VPC
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>subnet_id</span> = <span style=color:#a6e22e>aws_subnet</span>.<span style=color:#a6e22e>splunk_subnet_public</span>.<span style=color:#a6e22e>id</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>   # SG
</span><span style=color:#75715e></span>   <span style=color:#a6e22e>vpc_security_group_ids</span> = [<span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>splunk_sg</span>.<span style=color:#a6e22e>id</span>]
   <span style=color:#a6e22e>root_block_device</span> {
     <span style=color:#a6e22e>volume_type</span> = <span style=color:#e6db74>&#34;gp2&#34;</span>
     <span style=color:#a6e22e>volume_size</span> = <span style=color:#ae81ff>16</span>
   }
   <span style=color:#a6e22e>user_data</span> = file(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>path</span>.module<span style=color:#e6db74>}</span><span style=color:#e6db74>/user_data_splunk.sh&#34;</span>)

   <span style=color:#a6e22e>tags</span> = {
     <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk&#34;</span>
   }
 }
<span style=color:#66d9ef>
</span><span style=color:#66d9ef> output</span> <span style=color:#e6db74>&#34;splunk_instance_id&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Instance ID&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_instance</span>.<span style=color:#a6e22e>splunk_instance</span>.<span style=color:#a6e22e>id</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef> output</span> <span style=color:#e6db74>&#34;splunk_instance_public_ip&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Public IP&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_instance</span>.<span style=color:#a6e22e>splunk_instance</span>.<span style=color:#a6e22e>public_ip</span>
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef> output</span> <span style=color:#e6db74>&#34;splunk_instance_private_ip&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Private IP&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_instance</span>.<span style=color:#a6e22e>splunk_instance</span>.<span style=color:#a6e22e>private_ip</span>
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># SG
</span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34;</span> <span style=color:#e6db74>&#34;splunk_sg&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Allow SSH inbound traffic&#34;</span>
  <span style=color:#a6e22e>vpc_id</span>      = <span style=color:#a6e22e>aws_vpc</span>.<span style=color:#a6e22e>splunk_vpc</span>.<span style=color:#a6e22e>id</span>

  <span style=color:#a6e22e>ingress</span> {
    <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;Splunk Port 8000 from Home Netowrk&#34;</span>
    <span style=color:#a6e22e>from_port</span>   = <span style=color:#ae81ff>8000</span>
    <span style=color:#a6e22e>to_port</span>     = <span style=color:#ae81ff>8000</span>
    <span style=color:#a6e22e>protocol</span>    = <span style=color:#e6db74>&#34;tcp&#34;</span>
    <span style=color:#a6e22e>cidr_blocks</span> = [<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>home_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/32&#34;</span>]
  }

  <span style=color:#a6e22e>ingress</span> {
    <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;SSH from Home Netowrk&#34;</span>
    <span style=color:#a6e22e>from_port</span>   = <span style=color:#ae81ff>22</span>
    <span style=color:#a6e22e>to_port</span>     = <span style=color:#ae81ff>22</span>
    <span style=color:#a6e22e>protocol</span>    = <span style=color:#e6db74>&#34;tcp&#34;</span>
    <span style=color:#a6e22e>cidr_blocks</span> = [<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>var.<span style=color:#a6e22e>home_ip</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/32&#34;</span>]
  }

  <span style=color:#a6e22e>egress</span> {
    <span style=color:#a6e22e>from_port</span>   = <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>to_port</span>     = <span style=color:#ae81ff>0</span>
    <span style=color:#a6e22e>protocol</span>    = <span style=color:#e6db74>&#34;-1&#34;</span>
    <span style=color:#a6e22e>cidr_blocks</span> = [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
  }

  <span style=color:#a6e22e>tags</span> = {
    <span style=color:#a6e22e>Name</span> = <span style=color:#e6db74>&#34;splunk_sg&#34;</span>
  }
}
<span style=color:#66d9ef>
</span><span style=color:#66d9ef>output</span> <span style=color:#e6db74>&#34;splunk_sg&#34;</span> {
  <span style=color:#a6e22e>description</span> = <span style=color:#e6db74>&#34;The ID of the security group&#34;</span>
  <span style=color:#a6e22e>value</span>       = <span style=color:#a6e22e>aws_security_group</span>.<span style=color:#a6e22e>splunk_sg</span>.<span style=color:#a6e22e>id</span>
}
</code></pre></div><p><strong>User Data</strong>: When you install Splunk Enterprise, you must create a username and password for your administrator account. We will create admin credentials using the <code>--gen-and-print-passwd</code> CLI arguments.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#! /bin/bash -xe
</span><span style=color:#75715e></span>exec &gt; &gt;<span style=color:#f92672>(</span>tee /var/log/user-data.log|logger -t user-data -s 2&gt;/dev/console<span style=color:#f92672>)</span> 2&gt;&amp;<span style=color:#ae81ff>1</span>
echo BEGIN
sudo apt-get update
sudo apt-get upgrade -y
cd /tmp <span style=color:#f92672>&amp;&amp;</span> wget -O splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb  
<span style=color:#e6db74>&#39;https://www.splunk.com/bin/splunk/DownloadActivityServlet?architecture=x86_64&amp;platform=linux&amp;version=8.0.3&amp;product=splunk&amp;filename=splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb&amp;wget=true&#39;</span>
cd /opt
sudo dpkg -i /tmp/splunk-8.0.3-a6754d8441bf-linux-2.6-amd64.deb
cd splunk/
/opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt --gen-and-print-passwd
echo END
</code></pre></div><h3 id=9-login-to-splunk-instance-using-the-public-ip-of-the-ec2-instance>9. Login to Splunk Instance using the public IP of the EC2 instance<a hidden class=anchor aria-hidden=true href=#9-login-to-splunk-instance-using-the-public-ip-of-the-ec2-instance>#</a></h3>
<p>Browse to <code>http://public_ip:8000</code></p>
<p><strong>username</strong>: admin<br>
<strong>password</strong>: You need to grab from the file /var/log/user-data.log</p>
<p>It will be randomly generated as we used the option <code>--gen-and-print-passwd</code></p>
<h3 id=10-install-these-two-apps-on-the-splunk-instance>10. Install these two apps on the Splunk Instance.<a hidden class=anchor aria-hidden=true href=#10-install-these-two-apps-on-the-splunk-instance>#</a></h3>
<ul>
<li><a href=https://splunkbase.splunk.com/app/1876/>Splunk Add-on for Amazon Web Services</a></li>
<li><a href=https://splunkbase.splunk.com/app/1274/>Splunk App for AWS</a></li>
</ul>
<p>Once the apps are installed, restart Splunk.</p>
<h3 id=11-go-to-app-splunk-add-on-for-aws-and-go-under-the-configuration-tab-youll-see-role-assigned-to-the-splunk-instance-will-populate-in-a-couple-of-seconds>11. Go to App: Splunk Add-on for AWS and go under the &ldquo;Configuration&rdquo; tab, you&rsquo;ll see Role Assigned to the Splunk instance will populate in a couple of seconds.<a hidden class=anchor aria-hidden=true href=#11-go-to-app-splunk-add-on-for-aws-and-go-under-the-configuration-tab-youll-see-role-assigned-to-the-splunk-instance-will-populate-in-a-couple-of-seconds>#</a></h3>
<p><img loading=lazy src=/images/2020_04_20_1.png alt>
</p>
<h3 id=12-go-to-inputs-tab>12. Go to &ldquo;Inputs&rdquo; tab<a hidden class=anchor aria-hidden=true href=#12-go-to-inputs-tab>#</a></h3>
<p>Create a New Input selectng Data Type <strong>CloudTrail</strong> and Input Type <strong>SQS-Based S3</strong></p>
<p><img loading=lazy src=/images/2020_04_20_2.png alt>
</p>
<h3 id=13-fill-out-the-aws-input-configuration-details>13. Fill out the AWS Input Configuration details<a hidden class=anchor aria-hidden=true href=#13-fill-out-the-aws-input-configuration-details>#</a></h3>
<ul>
<li>Please note under the <strong>AWS Account</strong>, name of the role assigned to the Instance will automatically show up.</li>
<li>For the <strong>SQS Queue Name</strong>, you will see two SQS queues we created in earlier post. Please select the Event Notification Queue.</li>
<li>For the <strong>Index</strong>, either you can create a new index for CloudTrail logs or using existing one.</li>
</ul>
<p><img loading=lazy src=/images/2020_04_20_3.pn alt>
</p>
<h3 id=14-go-to-search--reporting-app>14. Go to <code>Search & Reporting</code> App<a hidden class=anchor aria-hidden=true href=#14-go-to-search--reporting-app>#</a></h3>
<p>Search for the CloudTrail logs using the SPL:</p>
<pre tabindex=0><code>index=main sourcetype=&quot;aws:cloudtrail&quot;
| table _time eventSource eventName eventType errorCode awsRegion userIdentity.accountId
</code></pre><p><img loading=lazy src=/images/2020_04_20_4.png alt>
</p>
<hr>
<p><strong>Summary</strong>: In this post, we learnt how to setup up a Splunk environment on AWS for lab purposes. We used Terraform to setup the AWS environment and then manually configured Splunk to integrate the CloudTrail logs.</p>
<hr>
<h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2>
<ul>
<li><a href=https://docs.splunk.com/Documentation/Splunk/latest/Security/Secureyouradminaccount#Create_admin_credentials_after_starting_Splunk_Enterprise>https://docs.splunk.com/Documentation/Splunk/latest/Security/Secureyouradminaccount#Create_admin_credentials_after_starting_Splunk_Enterprise</a></li>
<li><a href=https://docs.splunk.com/Documentation/AddOns/released/AWS/Setuptheadd-on>https://docs.splunk.com/Documentation/AddOns/released/AWS/Setuptheadd-on</a></li>
</ul>
</div>
<footer class=post-footer>
<nav class=paginav>
<a class=prev href=https://harwinds.github.io/logsec/posts/ingest-vpc-flow-logs-to-splunk/>
<span class=title>« Prev Page</span>
<br>
<span>Ingest VPC Flow Logs with Additional Meta-Data to Splunk</span>
</a>
</nav>
</footer><script src=https://giscus.app/client.js data-repo=harwinds/logsec data-repo-id="MDEwOlJlcG9zaXRvcnkzNDI0NDI5MjQ=" data-category=General data-category-id=DIC_kwDOFGlDrM4B-2FE data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=dark_dimmed data-lang=en crossorigin=anonymous async></script>
</article>
</main>
<footer class=footer>
<span>&copy; 2021 <a href=https://harwinds.github.io/logsec>logsec</a></span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>